// This is the server-side file of our mobile remote controller app.
// It initializes socket.io and a new express instance.
// Start it by running 'node app.js' from your terminal.

//Once Running the app interacts with the presentation layer via
//socket.on and socket.emit with the page scripts in public/assests/js/scripts.js


// Creating an express server

var express = require('express'),
	app = express();

// Set up port for our app to run on.
var port = process.env.PORT || 8080;

// Initialize a new socket.io object. It is bound to 
// the express app, which allows them to coexist.
var io = require('socket.io').listen(app.listen(port));

//Initialize node crypto
var crypto = require('crypto');



// App Configuration

// Make the files in the public folder available to the world
app.use(express.static(__dirname + '/public'));

//array to hold room codes
var roomCodes = [];

// Initialize a new socket.io application
var presentation = io.on('connection', function (socket) {
	// Browser views of site will call to get and return connection code
	socket.on('getRoom', function(data){
		// This will generate a room between your phone and browser, the room id will prevents others from opening your presentation
		// and controlling it. It is a Dynamically generated 3 byte hex string.
		room = crypto.randomBytes(3).toString('hex');
		//verify uniqueness of room id
		while(room in roomCodes)
         {
            room = crypto.randomBytes(3).toString('hex');
         }
        //add roomid to roomCodes array
        //set room to object to store quiz data
        roomCodes[room] = {'one' : 'one'};
        //
        socket.roomCode = room;
        console.log('Join : ');
        console.log(roomCodes);
		socket.join(room);

		io.sockets.in(room).emit('returnRoom', {
			room: room
		});
	});



	// A new controller has come online. Check the connection and 
	// emit a "granted" or "denied" message.

	socket.on('load', function(data){
		//check that room exists
		if(roomCodes.hasOwnProperty(data.room) == true) {
			//have the controller join the room
			socket.join(data.room);
			socket.roomCode = data.room;
			console.log('controller socket:' + socket.roomCode);
			//return access
			io.sockets.in(data.room).emit('access', {
				access: "granted",
				room: data.room
			});
		}else{
			//deny access
			io.sockets.in(data.room).emit('access', {
				access: "denied",
				room: data.room
			});
		}
		

	});

	// Clients send the 'slide-changed' message whenever they navigate to a new slide.

	socket.on('slide-changed', function(data){

		// Check the secret key again

		if(roomCodes.hasOwnProperty(data.room) == true) {

			// Tell all connected clients to navigate to the new slide
			
			presentation.in(data.room).emit('navigate', {
				hash: data.hash,
				room: data.room
			});
		}

	});
	socket.on('disconnect', function () {
			delete roomCodes[socket.roomCode];
			console.log('left : ');
			console.log(roomCodes);
    });

});

console.log('Your presentation is running on http://localhost:' + port);
